<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用 Cypress 拯救业务项目的前端自动化测试 · Minibase</title><meta name="description" content="用 Cypress 拯救业务项目的前端自动化测试 - Colafornia"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.colafornia.me/atom.xml" title="Minibase"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/colafornia" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">用 Cypress 拯救业务项目的前端自动化测试</h1><div class="post-info">Oct 24, 2019</div><div class="post-content"><p><img src="/images/cypress.png" alt="cypress-cover"></p>
<p>关于前端测试的一些理论与基于 <code>Cypress</code> 的 E2E 测试具体实践。</p>
<a id="more"></a>
<h2 id="关于前端自动化测试的一些碎碎念"><a href="#关于前端自动化测试的一些碎碎念" class="headerlink" title="关于前端自动化测试的一些碎碎念"></a>关于前端自动化测试的一些碎碎念</h2><p>日常业务项目开发的痛点之一便是前端的<code>回归测试</code>，免不了各种手动点点点，但凡改动了某个公用组件，函数，都要漫山遍野地把项目的主要页面都点进去看一遍有没有问题。项目用了 <code>GraphQL</code> 的话，Schema 一个更新不及时，某个没注意到的页面就挂了，然后就等着开 issue 或者报线上 Bug 吧 😐</p>
<p>通过人工手动点点点不仅是累，也并不靠谱，没法保证每一次都测到了需要回归测试的功能。想解决这一痛点，就不得不提<code>前端的自动化测试</code>。通过命令行跑测试，集成 CI 自动测试岂不美滋滋。</p>
<p>然而，国内各厂对于前端自动化测试尚未形成很好的实践，说起自动化测试，大家想到的也还是后端测试。几次技术大会（JSConf、GMTC 等等）里关于前端测试的话题也是寥寥无几，有的话也是国外前端工程师的分享，或是 QA 关于搭建测试平台的分享。</p>
<p>在我的经验里，<strong>对于业务项目而言的前端测试</strong>都很“尴尬”。如果是开发工具库，那可以通过单元测试来保证质量，如果是开发 UI 组件库，可以通过 <a href="https://storybook.js.org/" target="_blank" rel="external">Storybook</a> 来进行视觉与快照测试。所以之前每每想到业务项目如何集成自动化测试都感觉无从下手（还有几次是被比业务代码还多的测试代码吓跑了）。</p>
<p>但是业务项目里并没有太多工具函数需要单元测试（大部分通过 lodash 或其他第三方库来解决复杂逻辑处理），UI 组件也基本是直接采用了业界比较成熟的 ant-mobile, ant-design 等方案，需要在业务项目中开发的 UI 组件并不多，大多数是在第三方的 UI 组件基础上结合业务逻辑进行二次封装（事实上 ant-design 也把自己的组件单独放到 <a href="https://github.com/react-component" target="_blank" rel="external">https://github.com/react-component</a> 里维护了）。</p>
<p>业务项目里需要自动化测试的场景主要是想覆盖用户的主要使用路径，例如登录注册，加购到购物车，查看操作订单，修改个人信息等等，都是与 UI 界面的渲染逻辑强相关的，需要测试这些页面的表单提交，自动跳转，数据渲染是否有异常。</p>
<p>所以在此可以梳理一下我们的需求是：</p>
<blockquote>
<ol>
<li>可以模拟用户的点击输入操作，事件驱动来验证页面渲染是否符合预期</li>
<li>可以使用命令行跑测试，可以集成到 CI</li>
<li>轻量高效，环境易搭建，测试代码易编写（毕竟是作为对敏捷开发，持续集成的环节补充，并不是 QA 环节的测试，不应舍本逐末）</li>
</ol>
</blockquote>
<p>想到这里不难发现，前端业务项目里最需要的是 E2E 测试，但是在如题图的测试金字塔所示，E2E 测试在金字塔顶端，执行 E2E 测试成本高又速度慢。因此 <a href="https://github.com/cypress-io/cypress" target="_blank" rel="external">Cypress</a> 应运而生，Cypress 提供了完备的解决方案，从测试金字塔顶端的 E2E 到集成测试再到单元测试都实现。</p>
<h2 id="Cypress"><a href="#Cypress" class="headerlink" title="Cypress"></a>Cypress</h2><p>Cypress 是在 Mocha API 的基础上开发的一套开箱即用的 E2E 测试框架，并不依赖前端框架，也无需其他测试工具库，配置简单，并且提供了强大的 GUI 图形工具，可以自动截图录屏，实现时空旅行并在测试流程中 Debug 等等。</p>
<p>总结一下，Cypress 的优点有：</p>
<blockquote>
<ol>
<li>配置简单，可快速集成到现有项目中</li>
<li>支持所有等级的测试（即前面所提到的 e2e 测试，集成测试，单元测试等）</li>
<li>可以给每一步测试都生成快照，易于 Debug</li>
<li>可以获取、操作 Web 页面里的所有 DOM 节点</li>
<li>自动重试功能，Cypress 会在当前节点重试几次再断定测试失败</li>
<li>易于集成到 CI 系统中</li>
</ol>
</blockquote>
<p>与其它类似测试工具如 Selenium、Puppeteer、Nightwatch 相比，Cypress 的测试代码语法更简单，并且在保证了框架的轻量高效的前提下，对前端工程师更友好。</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89haxufrqj317k0u0dwx.jpg" alt="cypress-gui"></p>
<video autoplay loop src="https://www.cypress.io/static/running-tests-a75997cdc1013fc4b1705c1be3a094c7.webm"></video>

<p>简单介绍一下使用方法（具体可以参照<a href="https://docs.cypress.io/guides/overview/why-cypress.html" target="_blank" rel="external">官网引导</a>）：</p>
<p>安装：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn add cypress --dev</div></pre></td></tr></table></figure>
<p>添加到项目的 npm 脚本中：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"cypress:open"</span>: <span class="string">"cypress open"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根目录里配置 <code>cypress.json</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    "baseUrl": "http://localhost:8080", // 本地启动的 webpack-dev-server 地址</div><div class="line">    "viewportHeight": 800, // 测试环境的页面视口高度</div><div class="line">    "viewportWidth": 1280 // 测试环境的页面视口宽度</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm run cypress:open</div></pre></td></tr></table></figure>
<p>这就已经在本地打开了测试 GUI，可以进行测试了。</p>
<p>用官方文档的一个例子说明一下测试代码怎么写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'My First Test'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  it(<span class="string">'Gets, types and asserts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    cy.visit(<span class="string">'https://example.cypress.io'</span>)</div><div class="line"></div><div class="line">    cy.contains(<span class="string">'type'</span>).click()</div><div class="line"></div><div class="line">    <span class="comment">// Should be on a new URL which includes '/commands/actions'</span></div><div class="line">    cy.url().should(<span class="string">'include'</span>, <span class="string">'/commands/actions'</span>)</div><div class="line"></div><div class="line">    <span class="comment">// Get an input, type into it and verify that the value has been updated</span></div><div class="line">    cy.get(<span class="string">'.action-email'</span>)</div><div class="line">      .type(<span class="string">'fake@email.com'</span>)</div><div class="line">      .should(<span class="string">'have.value'</span>, <span class="string">'fake@email.com'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<video autoplay loop src="https://docs.cypress.io/img/snippets/first-test-assertions-30fps.1fbd2a2d.mp4"></video>

<p>这其实已经测试了：</p>
<ol>
<li>打开目标页面，这里是示例的 <a href="https://example.cypress.io，" target="_blank" rel="external">https://example.cypress.io，</a> 实际上在项目里应是本地启动的 server 页面如 <a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a></li>
<li>找到页面的 dom 里文字内容为 ‘type’ 的按钮，点击（如果页面里并没有渲染这个按钮即测试没跑通）</li>
<li>按钮点击后，页面应跳转到了路由中包含 ‘/commands/actions’ 的页面</li>
<li>在此页面的 dom 里可以找到 class 类名为 ‘.action-email’ 的 input 框，在里面输入 ‘fake@email.com’ 后，输入框的 value 值应该为 ‘fake@email.com’</li>
</ol>
<p>测试代码语义化比较好，代码量不多，也不需要写很多 async 逻辑。</p>
<p>到这里为止体验了一下安装配置，本地测试，感觉还可以，功能丰富，上手比较简单，集成到项目里也不麻烦。</p>
<h2 id="测试覆盖率与持续集成（Gitlab-为例）"><a href="#测试覆盖率与持续集成（Gitlab-为例）" class="headerlink" title="测试覆盖率与持续集成（Gitlab 为例）"></a>测试覆盖率与持续集成（Gitlab 为例）</h2><p>凡是没有集成到 CI 里的测试都只是玩具，并不能算数。所以我们来看看 Cypress 这块的表现吧。</p>
<p>我们希望 Cypress 可以通过配置，在开发的不同阶段执行不同的测试命令。比如在发起 PR 到 feature 分支时可以在当前分支执行集成测试，到 master 主分支时还需计算测试覆盖率并将数据上报到 Sonar 等质检平台（还可以设置测试覆盖率不满足xx%的话则测试失败等等）。</p>
<p>因此我们先看看测试覆盖率要怎么计算。Cypress 的测试覆盖率计算貌似是后来才添加上的功能，配置稍有点复杂。</p>
<p>依然还是具体说明可以<a href="https://docs.cypress.io/guides/tooling/code-coverage.html#E2E-code-coverage" target="_blank" rel="external">参照文档</a>，博客中只是简单介绍一下：</p>
<p>首先安装依赖：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -D @cypress/code-coverage nyc istanbul-lib-coverage</div></pre></td></tr></table></figure>
<p>再配置一下 Cypress 中的配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cypress/support/index.js</span></div><div class="line"><span class="keyword">import</span> <span class="string">'@cypress/code-coverage/support'</span></div><div class="line"></div><div class="line"><span class="comment">// cypress/plugins/index.js</span></div><div class="line"><span class="built_in">module</span>.exports = (on, config) =&gt; &#123;</div><div class="line">  on(<span class="string">'task'</span>, <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/task'</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>文档只介绍到这里，如果项目用了 TypeScript 的话这就还远远不够，翻了一下官方的 github 示例才发现还需要几个步骤：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -D babel-plugin-istanbul</div></pre></td></tr></table></figure>
<p>设置一下 <code>.babelrc</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [<span class="string">"istanbul"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再修改一下 <code>cypress/plugins/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cypress/plugins/index.js</span></div><div class="line"><span class="built_in">module</span>.exports = (on, config) =&gt; &#123;</div><div class="line">  on(<span class="string">'task'</span>, <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/task'</span>))</div><div class="line">  on(<span class="string">'file:preprocessor'</span>, <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/use-babelrc'</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">"cy:run": "cypress run &amp;&amp; npm run test:report",</div><div class="line">"instrument": "nyc instrument --compact=false client instrumented",</div><div class="line">"test:report": "npm run instrument &amp;&amp; npx nyc report --reporter=text-summary",</div></pre></td></tr></table></figure>
<p>通过 <code>cypress run</code> 可以直接在命令行跑测试，不启动 GUI，在 CI 里使用的话就该用这个命令。</p>
<p>看看结果，真是快快乐乐。</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89hawy7ymj30gn034glt.jpg" alt="coverage-result"></p>
<p>Cypress 的 E2E 测试的覆盖率也可以和单元测试，或是通过其它框架 Jest 等的测试覆盖率进行合并，具体方法可以去官网查找。</p>
<p>下面我们来以 Gitlab CI runner 为例来看一下 Cypress 怎么集成到 CI：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">// .gitlab-ci.yml</div><div class="line"><span class="attr">variables:</span></div><div class="line"><span class="attr">  npm_config_cache:</span> <span class="string">"$CI_PROJECT_DIR/.npm"</span></div><div class="line"><span class="attr">  CYPRESS_CACHE_FOLDER:</span> <span class="string">"$CI_PROJECT_DIR/cache/Cypress"</span></div><div class="line"></div><div class="line"><span class="attr">stages:</span></div><div class="line"><span class="bullet">  -</span> test</div><div class="line"><span class="bullet">  -</span> sonar</div><div class="line"></div><div class="line"><span class="attr">cache:</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">  -</span> .npm</div><div class="line"><span class="bullet">  -</span> node_modules/</div><div class="line"><span class="bullet">  -</span> cache/Cypress</div><div class="line"></div><div class="line"><span class="attr">build:</span></div><div class="line"><span class="attr">  stage:</span> sonar</div><div class="line"><span class="attr">  tags:</span></div><div class="line"><span class="bullet">    -</span> docker</div><div class="line"><span class="attr">  script:</span></div><div class="line"><span class="bullet">    -</span> yarn</div><div class="line"><span class="bullet">    -</span> sh ci/sonar.sh</div><div class="line"><span class="bullet">    -</span> yarn build</div><div class="line"><span class="attr">  artifacts:</span></div><div class="line"><span class="attr">    expire_in:</span> <span class="number">7</span> day</div><div class="line"><span class="attr">    paths:</span></div><div class="line"><span class="bullet">      -</span> codeclimate.json</div><div class="line"><span class="bullet">      -</span> build</div><div class="line"></div><div class="line"><span class="attr">cypress-e2e-local:</span></div><div class="line"><span class="attr">  image:</span> cypress/base:<span class="number">10</span></div><div class="line"><span class="attr">  tags:</span></div><div class="line"><span class="bullet">    -</span> docker</div><div class="line"><span class="attr">  stage:</span> test</div><div class="line"><span class="attr">  script:</span></div><div class="line"><span class="bullet">    -</span> unset NODE_OPTIONS</div><div class="line"><span class="bullet">    -</span> yarn</div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress cache path</div><div class="line">    <span class="comment"># show all installed versions of Cypress binary</span></div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress install</div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress cache list</div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress verify</div><div class="line"><span class="bullet">    -</span> npm run test</div><div class="line"><span class="attr">  artifacts:</span></div><div class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> week</div><div class="line"><span class="attr">    when:</span> always</div><div class="line"><span class="attr">    paths:</span></div><div class="line"><span class="bullet">    -</span> coverage/lcov.info</div><div class="line"><span class="bullet">    -</span> cypress/screenshots</div><div class="line"><span class="bullet">    -</span> cypress/videos</div></pre></td></tr></table></figure>
<p>在这里我们设置了两个 CI 阶段，test 与 build(与 Sonar 扫描，数据上报等)，在 test 阶段中使用了 Cypress 的官方镜像 <code>cypress/base:10</code>。（其它环境变量设置和依赖如 Sonar 扫描，yarn 等都在我们自己的 Docker 镜像中）</p>
<p>其中 CI 所执行的命令 <code>npm run test</code> 是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">"test": "start-server-and-test start http://localhost:5000 cy:run"</div></pre></td></tr></table></figure>
<p>在这里为了简化命令，使用了 npm 包 <a href="https://github.com/bahmutov/start-server-and-test" target="_blank" rel="external">start-server-and-test</a> 来实现待本地 Server 启动之后再执行测试这一逻辑。</p>
<p>我们也在 <code>.gitlab-ci.yml</code> 中设置了 <code>artifacts</code>:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attr">artifacts:</span></div><div class="line"><span class="attr">  expire_in:</span> <span class="number">1</span> week</div><div class="line"><span class="attr">  when:</span> always</div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">  -</span> coverage/lcov.info</div><div class="line"><span class="bullet">  -</span> cypress/screenshots</div><div class="line"><span class="bullet">  -</span> cypress/videos</div></pre></td></tr></table></figure>
<p>这是 Gitlab 的 <a href="https://docs.gitlab.com/ee/user/project/pipelines/job_artifacts.html" target="_blank" rel="external">job artifacts</a> 功能，可以设置在某一步骤完成之后将特定文件夹的内容上传到服务器，在有效时间内，我们可以在网页端查看或下载这些文件内容。这样如果在 CI 测试失败的话我们就可以在 artifacts 中查看其测试失败视频和快照，避免盲猜式 Debug。</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89hawui46j307o03ldfu.jpg" alt="artifacts"></p>
<p>在 CI 设置和测试用例管理中可以深挖的点还有很多。比如将测试用例分为冒烟测试，全量测试，或者 Client 端测试，Node 层测试等等。</p>
<p>Cypress 可应用的测试场景也更多，比如通过设置 Cookie 实现不同权限用户的测试，引入 Chance.js 实现随机点击 Tab 进行不同选项卡的测试，Mock 接口返回值等等。</p>
<p><a href="https://glebbahmutov.com/blog/" target="_blank" rel="external">https://glebbahmutov.com/blog/</a> 是 Cypress 的主要维护者的博客，其中也记录了很多骚操作（比如检查网页对比度是否满足条件等等），如有兴趣，可以继续进行挖掘。</p>
<h2 id="一个坑点"><a href="#一个坑点" class="headerlink" title="一个坑点"></a>一个坑点</h2><p>在我的实践中发现的一个坑点是 <a href="https://github.com/cypress-io/cypress/issues/95" target="_blank" rel="external">Cypress 缺少对于 <code>fetch</code> 请求的支持</a>，它无法捕捉或者 mock 请求，只能通过一个有点脏的方法来 hack 解决。</p>
<p>在项目中引入<a href="https://github.com/whatwg/fetch" target="_blank" rel="external">whatwg-fetch</a>，再修改 <code>cypress/support/command.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cypress/support/command.js</span></div><div class="line">Cypress.Commands.add(<span class="string">'visitWithDelWinFetch'</span>, (path, opts = &#123;&#125;) =&gt; &#123;</div><div class="line">    cy.visit(</div><div class="line">        path,</div><div class="line">        <span class="built_in">Object</span>.assign(opts, &#123;</div><div class="line">            onBeforeLoad(win) &#123;</div><div class="line">                <span class="keyword">delete</span> win.fetch;</div><div class="line">            &#125;,</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这样我们就可以测试我们项目的登录重定向判断了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'Node server'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  it(<span class="string">'no cookie get 401'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    cy.server()</div><div class="line"></div><div class="line">    cy.clearCookies()</div><div class="line"></div><div class="line">    cy.route(<span class="string">'POST'</span>, <span class="string">'**/graphql'</span>).as(<span class="string">'login'</span>)</div><div class="line"></div><div class="line">    cy.visitWithDelWinFetch(<span class="string">'/'</span>);</div><div class="line"></div><div class="line">    cy.wait(<span class="string">'@login'</span>).then((xhr) =&gt; &#123;</div><div class="line">      expect(xhr.status).to.eq(<span class="number">401</span>)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'with cookie get 200'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    cy.server()</div><div class="line"></div><div class="line">    cy.route(<span class="string">'POST'</span>, <span class="string">'**/graphql'</span>).as(<span class="string">'loginWithCookie'</span>)</div><div class="line"></div><div class="line">    cy.visitWithCookie(<span class="string">'/'</span>);</div><div class="line"></div><div class="line">    cy.wait(<span class="string">'@loginWithCookie'</span>).then((xhr) =&gt; &#123;</div><div class="line">      expect(xhr.status).to.eq(<span class="number">200</span>)</div><div class="line">    &#125;)</div><div class="line">    <span class="comment">// login successfully, so display the content</span></div><div class="line">    cy.get(<span class="string">'.ant-layout-sider'</span>)</div><div class="line">    cy.get(<span class="string">'.ant-layout-content'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>aha~</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89hawob9rj31180560ta.jpg" alt="sonar"></p>
</div></article></div></main><footer><div class="paginator"><a href="/post/2019/understand-golang-slice/" class="prev">PREV</a><a href="/post/2019/2019-webpack-optimization/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="https://blog.colafornia.me">Colafornia</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-84469017-1",'auto');ga('send','pageview');</script></body></html>