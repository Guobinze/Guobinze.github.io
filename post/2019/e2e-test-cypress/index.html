<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ç”¨ Cypress æ‹¯æ•‘ä¸šåŠ¡é¡¹ç›®çš„å‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯• Â· Minibase</title><meta name="description" content="ç”¨ Cypress æ‹¯æ•‘ä¸šåŠ¡é¡¹ç›®çš„å‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯• - Colafornia"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.colafornia.me/atom.xml" title="Minibase"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/colafornia" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ç”¨ Cypress æ‹¯æ•‘ä¸šåŠ¡é¡¹ç›®çš„å‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•</h1><div class="post-info">Oct 24, 2019</div><div class="post-content"><p><img src="/images/cypress.png" alt="cypress-cover"></p>
<p>å…³äºå‰ç«¯æµ‹è¯•çš„ä¸€äº›ç†è®ºä¸åŸºäº <code>Cypress</code> çš„ E2E æµ‹è¯•å…·ä½“å®è·µã€‚</p>
<a id="more"></a>
<h2 id="å…³äºå‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„ä¸€äº›ç¢ç¢å¿µ"><a href="#å…³äºå‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„ä¸€äº›ç¢ç¢å¿µ" class="headerlink" title="å…³äºå‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„ä¸€äº›ç¢ç¢å¿µ"></a>å…³äºå‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„ä¸€äº›ç¢ç¢å¿µ</h2><p>æ—¥å¸¸ä¸šåŠ¡é¡¹ç›®å¼€å‘çš„ç—›ç‚¹ä¹‹ä¸€ä¾¿æ˜¯å‰ç«¯çš„<code>å›å½’æµ‹è¯•</code>ï¼Œå…ä¸äº†å„ç§æ‰‹åŠ¨ç‚¹ç‚¹ç‚¹ï¼Œä½†å‡¡æ”¹åŠ¨äº†æŸä¸ªå…¬ç”¨ç»„ä»¶ï¼Œå‡½æ•°ï¼Œéƒ½è¦æ¼«å±±éé‡åœ°æŠŠé¡¹ç›®çš„ä¸»è¦é¡µé¢éƒ½ç‚¹è¿›å»çœ‹ä¸€éæœ‰æ²¡æœ‰é—®é¢˜ã€‚é¡¹ç›®ç”¨äº† <code>GraphQL</code> çš„è¯ï¼ŒSchema ä¸€ä¸ªæ›´æ–°ä¸åŠæ—¶ï¼ŒæŸä¸ªæ²¡æ³¨æ„åˆ°çš„é¡µé¢å°±æŒ‚äº†ï¼Œç„¶åå°±ç­‰ç€å¼€ issue æˆ–è€…æŠ¥çº¿ä¸Š Bug å§ ğŸ˜</p>
<p>é€šè¿‡äººå·¥æ‰‹åŠ¨ç‚¹ç‚¹ç‚¹ä¸ä»…æ˜¯ç´¯ï¼Œä¹Ÿå¹¶ä¸é è°±ï¼Œæ²¡æ³•ä¿è¯æ¯ä¸€æ¬¡éƒ½æµ‹åˆ°äº†éœ€è¦å›å½’æµ‹è¯•çš„åŠŸèƒ½ã€‚æƒ³è§£å†³è¿™ä¸€ç—›ç‚¹ï¼Œå°±ä¸å¾—ä¸æ<code>å‰ç«¯çš„è‡ªåŠ¨åŒ–æµ‹è¯•</code>ã€‚é€šè¿‡å‘½ä»¤è¡Œè·‘æµ‹è¯•ï¼Œé›†æˆ CI è‡ªåŠ¨æµ‹è¯•å²‚ä¸ç¾æ»‹æ»‹ã€‚</p>
<p>ç„¶è€Œï¼Œå›½å†…å„å‚å¯¹äºå‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•å°šæœªå½¢æˆå¾ˆå¥½çš„å®è·µï¼Œè¯´èµ·è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå¤§å®¶æƒ³åˆ°çš„ä¹Ÿè¿˜æ˜¯åç«¯æµ‹è¯•ã€‚å‡ æ¬¡æŠ€æœ¯å¤§ä¼šï¼ˆJSConfã€GMTC ç­‰ç­‰ï¼‰é‡Œå…³äºå‰ç«¯æµ‹è¯•çš„è¯é¢˜ä¹Ÿæ˜¯å¯¥å¯¥æ— å‡ ï¼Œæœ‰çš„è¯ä¹Ÿæ˜¯å›½å¤–å‰ç«¯å·¥ç¨‹å¸ˆçš„åˆ†äº«ï¼Œæˆ–æ˜¯ QA å…³äºæ­å»ºæµ‹è¯•å¹³å°çš„åˆ†äº«ã€‚</p>
<p>åœ¨æˆ‘çš„ç»éªŒé‡Œï¼Œ<strong>å¯¹äºä¸šåŠ¡é¡¹ç›®è€Œè¨€çš„å‰ç«¯æµ‹è¯•</strong>éƒ½å¾ˆâ€œå°´å°¬â€ã€‚å¦‚æœæ˜¯å¼€å‘å·¥å…·åº“ï¼Œé‚£å¯ä»¥é€šè¿‡å•å…ƒæµ‹è¯•æ¥ä¿è¯è´¨é‡ï¼Œå¦‚æœæ˜¯å¼€å‘ UI ç»„ä»¶åº“ï¼Œå¯ä»¥é€šè¿‡ <a href="https://storybook.js.org/" target="_blank" rel="external">Storybook</a> æ¥è¿›è¡Œè§†è§‰ä¸å¿«ç…§æµ‹è¯•ã€‚æ‰€ä»¥ä¹‹å‰æ¯æ¯æƒ³åˆ°ä¸šåŠ¡é¡¹ç›®å¦‚ä½•é›†æˆè‡ªåŠ¨åŒ–æµ‹è¯•éƒ½æ„Ÿè§‰æ— ä»ä¸‹æ‰‹ï¼ˆè¿˜æœ‰å‡ æ¬¡æ˜¯è¢«æ¯”ä¸šåŠ¡ä»£ç è¿˜å¤šçš„æµ‹è¯•ä»£ç å“è·‘äº†ï¼‰ã€‚</p>
<p>ä½†æ˜¯ä¸šåŠ¡é¡¹ç›®é‡Œå¹¶æ²¡æœ‰å¤ªå¤šå·¥å…·å‡½æ•°éœ€è¦å•å…ƒæµ‹è¯•ï¼ˆå¤§éƒ¨åˆ†é€šè¿‡ lodash æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹åº“æ¥è§£å†³å¤æ‚é€»è¾‘å¤„ç†ï¼‰ï¼ŒUI ç»„ä»¶ä¹ŸåŸºæœ¬æ˜¯ç›´æ¥é‡‡ç”¨äº†ä¸šç•Œæ¯”è¾ƒæˆç†Ÿçš„ ant-mobile, ant-design ç­‰æ–¹æ¡ˆï¼Œéœ€è¦åœ¨ä¸šåŠ¡é¡¹ç›®ä¸­å¼€å‘çš„ UI ç»„ä»¶å¹¶ä¸å¤šï¼Œå¤§å¤šæ•°æ˜¯åœ¨ç¬¬ä¸‰æ–¹çš„ UI ç»„ä»¶åŸºç¡€ä¸Šç»“åˆä¸šåŠ¡é€»è¾‘è¿›è¡ŒäºŒæ¬¡å°è£…ï¼ˆäº‹å®ä¸Š ant-design ä¹ŸæŠŠè‡ªå·±çš„ç»„ä»¶å•ç‹¬æ”¾åˆ° <a href="https://github.com/react-component" target="_blank" rel="external">https://github.com/react-component</a> é‡Œç»´æŠ¤äº†ï¼‰ã€‚</p>
<p>ä¸šåŠ¡é¡¹ç›®é‡Œéœ€è¦è‡ªåŠ¨åŒ–æµ‹è¯•çš„åœºæ™¯ä¸»è¦æ˜¯æƒ³è¦†ç›–ç”¨æˆ·çš„ä¸»è¦ä½¿ç”¨è·¯å¾„ï¼Œä¾‹å¦‚ç™»å½•æ³¨å†Œï¼ŒåŠ è´­åˆ°è´­ç‰©è½¦ï¼ŒæŸ¥çœ‹æ“ä½œè®¢å•ï¼Œä¿®æ”¹ä¸ªäººä¿¡æ¯ç­‰ç­‰ï¼Œéƒ½æ˜¯ä¸ UI ç•Œé¢çš„æ¸²æŸ“é€»è¾‘å¼ºç›¸å…³çš„ï¼Œéœ€è¦æµ‹è¯•è¿™äº›é¡µé¢çš„è¡¨å•æäº¤ï¼Œè‡ªåŠ¨è·³è½¬ï¼Œæ•°æ®æ¸²æŸ“æ˜¯å¦æœ‰å¼‚å¸¸ã€‚</p>
<p>æ‰€ä»¥åœ¨æ­¤å¯ä»¥æ¢³ç†ä¸€ä¸‹æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ï¼š</p>
<blockquote>
<ol>
<li>å¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·çš„ç‚¹å‡»è¾“å…¥æ“ä½œï¼Œäº‹ä»¶é©±åŠ¨æ¥éªŒè¯é¡µé¢æ¸²æŸ“æ˜¯å¦ç¬¦åˆé¢„æœŸ</li>
<li>å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œè·‘æµ‹è¯•ï¼Œå¯ä»¥é›†æˆåˆ° CI</li>
<li>è½»é‡é«˜æ•ˆï¼Œç¯å¢ƒæ˜“æ­å»ºï¼Œæµ‹è¯•ä»£ç æ˜“ç¼–å†™ï¼ˆæ¯•ç«Ÿæ˜¯ä½œä¸ºå¯¹æ•æ·å¼€å‘ï¼ŒæŒç»­é›†æˆçš„ç¯èŠ‚è¡¥å……ï¼Œå¹¶ä¸æ˜¯ QA ç¯èŠ‚çš„æµ‹è¯•ï¼Œä¸åº”èˆæœ¬é€æœ«ï¼‰</li>
</ol>
</blockquote>
<p>æƒ³åˆ°è¿™é‡Œä¸éš¾å‘ç°ï¼Œå‰ç«¯ä¸šåŠ¡é¡¹ç›®é‡Œæœ€éœ€è¦çš„æ˜¯ E2E æµ‹è¯•ï¼Œä½†æ˜¯åœ¨å¦‚é¢˜å›¾çš„æµ‹è¯•é‡‘å­—å¡”æ‰€ç¤ºï¼ŒE2E æµ‹è¯•åœ¨é‡‘å­—å¡”é¡¶ç«¯ï¼Œæ‰§è¡Œ E2E æµ‹è¯•æˆæœ¬é«˜åˆé€Ÿåº¦æ…¢ã€‚å› æ­¤ <a href="https://github.com/cypress-io/cypress" target="_blank" rel="external">Cypress</a> åº”è¿è€Œç”Ÿï¼ŒCypress æä¾›äº†å®Œå¤‡çš„è§£å†³æ–¹æ¡ˆï¼Œä»æµ‹è¯•é‡‘å­—å¡”é¡¶ç«¯çš„ E2E åˆ°é›†æˆæµ‹è¯•å†åˆ°å•å…ƒæµ‹è¯•éƒ½å®ç°ã€‚</p>
<h2 id="Cypress"><a href="#Cypress" class="headerlink" title="Cypress"></a>Cypress</h2><p>Cypress æ˜¯åœ¨ Mocha API çš„åŸºç¡€ä¸Šå¼€å‘çš„ä¸€å¥—å¼€ç®±å³ç”¨çš„ E2E æµ‹è¯•æ¡†æ¶ï¼Œå¹¶ä¸ä¾èµ–å‰ç«¯æ¡†æ¶ï¼Œä¹Ÿæ— éœ€å…¶ä»–æµ‹è¯•å·¥å…·åº“ï¼Œé…ç½®ç®€å•ï¼Œå¹¶ä¸”æä¾›äº†å¼ºå¤§çš„ GUI å›¾å½¢å·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨æˆªå›¾å½•å±ï¼Œå®ç°æ—¶ç©ºæ—…è¡Œå¹¶åœ¨æµ‹è¯•æµç¨‹ä¸­ Debug ç­‰ç­‰ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒCypress çš„ä¼˜ç‚¹æœ‰ï¼š</p>
<blockquote>
<ol>
<li>é…ç½®ç®€å•ï¼Œå¯å¿«é€Ÿé›†æˆåˆ°ç°æœ‰é¡¹ç›®ä¸­</li>
<li>æ”¯æŒæ‰€æœ‰ç­‰çº§çš„æµ‹è¯•ï¼ˆå³å‰é¢æ‰€æåˆ°çš„ e2e æµ‹è¯•ï¼Œé›†æˆæµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•ç­‰ï¼‰</li>
<li>å¯ä»¥ç»™æ¯ä¸€æ­¥æµ‹è¯•éƒ½ç”Ÿæˆå¿«ç…§ï¼Œæ˜“äº Debug</li>
<li>å¯ä»¥è·å–ã€æ“ä½œ Web é¡µé¢é‡Œçš„æ‰€æœ‰ DOM èŠ‚ç‚¹</li>
<li>è‡ªåŠ¨é‡è¯•åŠŸèƒ½ï¼ŒCypress ä¼šåœ¨å½“å‰èŠ‚ç‚¹é‡è¯•å‡ æ¬¡å†æ–­å®šæµ‹è¯•å¤±è´¥</li>
<li>æ˜“äºé›†æˆåˆ° CI ç³»ç»Ÿä¸­</li>
</ol>
</blockquote>
<p>ä¸å…¶å®ƒç±»ä¼¼æµ‹è¯•å·¥å…·å¦‚ Seleniumã€Puppeteerã€Nightwatch ç›¸æ¯”ï¼ŒCypress çš„æµ‹è¯•ä»£ç è¯­æ³•æ›´ç®€å•ï¼Œå¹¶ä¸”åœ¨ä¿è¯äº†æ¡†æ¶çš„è½»é‡é«˜æ•ˆçš„å‰æä¸‹ï¼Œå¯¹å‰ç«¯å·¥ç¨‹å¸ˆæ›´å‹å¥½ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89haxufrqj317k0u0dwx.jpg" alt="cypress-gui"></p>
<video autoplay loop src="https://www.cypress.io/static/running-tests-a75997cdc1013fc4b1705c1be3a094c7.webm"></video>

<p>ç®€å•ä»‹ç»ä¸€ä¸‹ä½¿ç”¨æ–¹æ³•ï¼ˆå…·ä½“å¯ä»¥å‚ç…§<a href="https://docs.cypress.io/guides/overview/why-cypress.html" target="_blank" rel="external">å®˜ç½‘å¼•å¯¼</a>ï¼‰ï¼š</p>
<p>å®‰è£…ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn add cypress --dev</div></pre></td></tr></table></figure>
<p>æ·»åŠ åˆ°é¡¹ç›®çš„ npm è„šæœ¬ä¸­ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"cypress:open"</span>: <span class="string">"cypress open"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ ¹ç›®å½•é‡Œé…ç½® <code>cypress.json</code>ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    "baseUrl": "http://localhost:8080", // æœ¬åœ°å¯åŠ¨çš„ webpack-dev-server åœ°å€</div><div class="line">    "viewportHeight": 800, // æµ‹è¯•ç¯å¢ƒçš„é¡µé¢è§†å£é«˜åº¦</div><div class="line">    "viewportWidth": 1280 // æµ‹è¯•ç¯å¢ƒçš„é¡µé¢è§†å£å®½åº¦</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm run cypress:open</div></pre></td></tr></table></figure>
<p>è¿™å°±å·²ç»åœ¨æœ¬åœ°æ‰“å¼€äº†æµ‹è¯• GUIï¼Œå¯ä»¥è¿›è¡Œæµ‹è¯•äº†ã€‚</p>
<p>ç”¨å®˜æ–¹æ–‡æ¡£çš„ä¸€ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹æµ‹è¯•ä»£ç æ€ä¹ˆå†™ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'My First Test'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  it(<span class="string">'Gets, types and asserts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    cy.visit(<span class="string">'https://example.cypress.io'</span>)</div><div class="line"></div><div class="line">    cy.contains(<span class="string">'type'</span>).click()</div><div class="line"></div><div class="line">    <span class="comment">// Should be on a new URL which includes '/commands/actions'</span></div><div class="line">    cy.url().should(<span class="string">'include'</span>, <span class="string">'/commands/actions'</span>)</div><div class="line"></div><div class="line">    <span class="comment">// Get an input, type into it and verify that the value has been updated</span></div><div class="line">    cy.get(<span class="string">'.action-email'</span>)</div><div class="line">      .type(<span class="string">'fake@email.com'</span>)</div><div class="line">      .should(<span class="string">'have.value'</span>, <span class="string">'fake@email.com'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<video autoplay loop src="https://docs.cypress.io/img/snippets/first-test-assertions-30fps.1fbd2a2d.mp4"></video>

<p>è¿™å…¶å®å·²ç»æµ‹è¯•äº†ï¼š</p>
<ol>
<li>æ‰“å¼€ç›®æ ‡é¡µé¢ï¼Œè¿™é‡Œæ˜¯ç¤ºä¾‹çš„ <a href="https://example.cypress.ioï¼Œ" target="_blank" rel="external">https://example.cypress.ioï¼Œ</a> å®é™…ä¸Šåœ¨é¡¹ç›®é‡Œåº”æ˜¯æœ¬åœ°å¯åŠ¨çš„ server é¡µé¢å¦‚ <a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a></li>
<li>æ‰¾åˆ°é¡µé¢çš„ dom é‡Œæ–‡å­—å†…å®¹ä¸º â€˜typeâ€™ çš„æŒ‰é’®ï¼Œç‚¹å‡»ï¼ˆå¦‚æœé¡µé¢é‡Œå¹¶æ²¡æœ‰æ¸²æŸ“è¿™ä¸ªæŒ‰é’®å³æµ‹è¯•æ²¡è·‘é€šï¼‰</li>
<li>æŒ‰é’®ç‚¹å‡»åï¼Œé¡µé¢åº”è·³è½¬åˆ°äº†è·¯ç”±ä¸­åŒ…å« â€˜/commands/actionsâ€™ çš„é¡µé¢</li>
<li>åœ¨æ­¤é¡µé¢çš„ dom é‡Œå¯ä»¥æ‰¾åˆ° class ç±»åä¸º â€˜.action-emailâ€™ çš„ input æ¡†ï¼Œåœ¨é‡Œé¢è¾“å…¥ â€˜fake@email.comâ€™ åï¼Œè¾“å…¥æ¡†çš„ value å€¼åº”è¯¥ä¸º â€˜fake@email.comâ€™</li>
</ol>
<p>æµ‹è¯•ä»£ç è¯­ä¹‰åŒ–æ¯”è¾ƒå¥½ï¼Œä»£ç é‡ä¸å¤šï¼Œä¹Ÿä¸éœ€è¦å†™å¾ˆå¤š async é€»è¾‘ã€‚</p>
<p>åˆ°è¿™é‡Œä¸ºæ­¢ä½“éªŒäº†ä¸€ä¸‹å®‰è£…é…ç½®ï¼Œæœ¬åœ°æµ‹è¯•ï¼Œæ„Ÿè§‰è¿˜å¯ä»¥ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œä¸Šæ‰‹æ¯”è¾ƒç®€å•ï¼Œé›†æˆåˆ°é¡¹ç›®é‡Œä¹Ÿä¸éº»çƒ¦ã€‚</p>
<h2 id="æµ‹è¯•è¦†ç›–ç‡ä¸æŒç»­é›†æˆï¼ˆGitlab-ä¸ºä¾‹ï¼‰"><a href="#æµ‹è¯•è¦†ç›–ç‡ä¸æŒç»­é›†æˆï¼ˆGitlab-ä¸ºä¾‹ï¼‰" class="headerlink" title="æµ‹è¯•è¦†ç›–ç‡ä¸æŒç»­é›†æˆï¼ˆGitlab ä¸ºä¾‹ï¼‰"></a>æµ‹è¯•è¦†ç›–ç‡ä¸æŒç»­é›†æˆï¼ˆGitlab ä¸ºä¾‹ï¼‰</h2><p>å‡¡æ˜¯æ²¡æœ‰é›†æˆåˆ° CI é‡Œçš„æµ‹è¯•éƒ½åªæ˜¯ç©å…·ï¼Œå¹¶ä¸èƒ½ç®—æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬æ¥çœ‹çœ‹ Cypress è¿™å—çš„è¡¨ç°å§ã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ› Cypress å¯ä»¥é€šè¿‡é…ç½®ï¼Œåœ¨å¼€å‘çš„ä¸åŒé˜¶æ®µæ‰§è¡Œä¸åŒçš„æµ‹è¯•å‘½ä»¤ã€‚æ¯”å¦‚åœ¨å‘èµ· PR åˆ° feature åˆ†æ”¯æ—¶å¯ä»¥åœ¨å½“å‰åˆ†æ”¯æ‰§è¡Œé›†æˆæµ‹è¯•ï¼Œåˆ° master ä¸»åˆ†æ”¯æ—¶è¿˜éœ€è®¡ç®—æµ‹è¯•è¦†ç›–ç‡å¹¶å°†æ•°æ®ä¸ŠæŠ¥åˆ° Sonar ç­‰è´¨æ£€å¹³å°ï¼ˆè¿˜å¯ä»¥è®¾ç½®æµ‹è¯•è¦†ç›–ç‡ä¸æ»¡è¶³xx%çš„è¯åˆ™æµ‹è¯•å¤±è´¥ç­‰ç­‰ï¼‰ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å…ˆçœ‹çœ‹æµ‹è¯•è¦†ç›–ç‡è¦æ€ä¹ˆè®¡ç®—ã€‚Cypress çš„æµ‹è¯•è¦†ç›–ç‡è®¡ç®—è²Œä¼¼æ˜¯åæ¥æ‰æ·»åŠ ä¸Šçš„åŠŸèƒ½ï¼Œé…ç½®ç¨æœ‰ç‚¹å¤æ‚ã€‚</p>
<p>ä¾ç„¶è¿˜æ˜¯å…·ä½“è¯´æ˜å¯ä»¥<a href="https://docs.cypress.io/guides/tooling/code-coverage.html#E2E-code-coverage" target="_blank" rel="external">å‚ç…§æ–‡æ¡£</a>ï¼Œåšå®¢ä¸­åªæ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p>
<p>é¦–å…ˆå®‰è£…ä¾èµ–ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -D @cypress/code-coverage nyc istanbul-lib-coverage</div></pre></td></tr></table></figure>
<p>å†é…ç½®ä¸€ä¸‹ Cypress ä¸­çš„é…ç½®ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cypress/support/index.js</span></div><div class="line"><span class="keyword">import</span> <span class="string">'@cypress/code-coverage/support'</span></div><div class="line"></div><div class="line"><span class="comment">// cypress/plugins/index.js</span></div><div class="line"><span class="built_in">module</span>.exports = (on, config) =&gt; &#123;</div><div class="line">  on(<span class="string">'task'</span>, <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/task'</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–‡æ¡£åªä»‹ç»åˆ°è¿™é‡Œï¼Œå¦‚æœé¡¹ç›®ç”¨äº† TypeScript çš„è¯è¿™å°±è¿˜è¿œè¿œä¸å¤Ÿï¼Œç¿»äº†ä¸€ä¸‹å®˜æ–¹çš„ github ç¤ºä¾‹æ‰å‘ç°è¿˜éœ€è¦å‡ ä¸ªæ­¥éª¤ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -D babel-plugin-istanbul</div></pre></td></tr></table></figure>
<p>è®¾ç½®ä¸€ä¸‹ <code>.babelrc</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [<span class="string">"istanbul"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†ä¿®æ”¹ä¸€ä¸‹ <code>cypress/plugins/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cypress/plugins/index.js</span></div><div class="line"><span class="built_in">module</span>.exports = (on, config) =&gt; &#123;</div><div class="line">  on(<span class="string">'task'</span>, <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/task'</span>))</div><div class="line">  on(<span class="string">'file:preprocessor'</span>, <span class="built_in">require</span>(<span class="string">'@cypress/code-coverage/use-babelrc'</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">"cy:run": "cypress run &amp;&amp; npm run test:report",</div><div class="line">"instrument": "nyc instrument --compact=false client instrumented",</div><div class="line">"test:report": "npm run instrument &amp;&amp; npx nyc report --reporter=text-summary",</div></pre></td></tr></table></figure>
<p>é€šè¿‡ <code>cypress run</code> å¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œè·‘æµ‹è¯•ï¼Œä¸å¯åŠ¨ GUIï¼Œåœ¨ CI é‡Œä½¿ç”¨çš„è¯å°±è¯¥ç”¨è¿™ä¸ªå‘½ä»¤ã€‚</p>
<p>çœ‹çœ‹ç»“æœï¼ŒçœŸæ˜¯å¿«å¿«ä¹ä¹ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89hawy7ymj30gn034glt.jpg" alt="coverage-result"></p>
<p>Cypress çš„ E2E æµ‹è¯•çš„è¦†ç›–ç‡ä¹Ÿå¯ä»¥å’Œå•å…ƒæµ‹è¯•ï¼Œæˆ–æ˜¯é€šè¿‡å…¶å®ƒæ¡†æ¶ Jest ç­‰çš„æµ‹è¯•è¦†ç›–ç‡è¿›è¡Œåˆå¹¶ï¼Œå…·ä½“æ–¹æ³•å¯ä»¥å»å®˜ç½‘æŸ¥æ‰¾ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ä»¥ Gitlab CI runner ä¸ºä¾‹æ¥çœ‹ä¸€ä¸‹ Cypress æ€ä¹ˆé›†æˆåˆ° CIï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">// .gitlab-ci.yml</div><div class="line"><span class="attr">variables:</span></div><div class="line"><span class="attr">  npm_config_cache:</span> <span class="string">"$CI_PROJECT_DIR/.npm"</span></div><div class="line"><span class="attr">  CYPRESS_CACHE_FOLDER:</span> <span class="string">"$CI_PROJECT_DIR/cache/Cypress"</span></div><div class="line"></div><div class="line"><span class="attr">stages:</span></div><div class="line"><span class="bullet">  -</span> test</div><div class="line"><span class="bullet">  -</span> sonar</div><div class="line"></div><div class="line"><span class="attr">cache:</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">  -</span> .npm</div><div class="line"><span class="bullet">  -</span> node_modules/</div><div class="line"><span class="bullet">  -</span> cache/Cypress</div><div class="line"></div><div class="line"><span class="attr">build:</span></div><div class="line"><span class="attr">  stage:</span> sonar</div><div class="line"><span class="attr">  tags:</span></div><div class="line"><span class="bullet">    -</span> docker</div><div class="line"><span class="attr">  script:</span></div><div class="line"><span class="bullet">    -</span> yarn</div><div class="line"><span class="bullet">    -</span> sh ci/sonar.sh</div><div class="line"><span class="bullet">    -</span> yarn build</div><div class="line"><span class="attr">  artifacts:</span></div><div class="line"><span class="attr">    expire_in:</span> <span class="number">7</span> day</div><div class="line"><span class="attr">    paths:</span></div><div class="line"><span class="bullet">      -</span> codeclimate.json</div><div class="line"><span class="bullet">      -</span> build</div><div class="line"></div><div class="line"><span class="attr">cypress-e2e-local:</span></div><div class="line"><span class="attr">  image:</span> cypress/base:<span class="number">10</span></div><div class="line"><span class="attr">  tags:</span></div><div class="line"><span class="bullet">    -</span> docker</div><div class="line"><span class="attr">  stage:</span> test</div><div class="line"><span class="attr">  script:</span></div><div class="line"><span class="bullet">    -</span> unset NODE_OPTIONS</div><div class="line"><span class="bullet">    -</span> yarn</div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress cache path</div><div class="line">    <span class="comment"># show all installed versions of Cypress binary</span></div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress install</div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress cache list</div><div class="line"><span class="bullet">    -</span> $(npm bin)/cypress verify</div><div class="line"><span class="bullet">    -</span> npm run test</div><div class="line"><span class="attr">  artifacts:</span></div><div class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> week</div><div class="line"><span class="attr">    when:</span> always</div><div class="line"><span class="attr">    paths:</span></div><div class="line"><span class="bullet">    -</span> coverage/lcov.info</div><div class="line"><span class="bullet">    -</span> cypress/screenshots</div><div class="line"><span class="bullet">    -</span> cypress/videos</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†ä¸¤ä¸ª CI é˜¶æ®µï¼Œtest ä¸ build(ä¸ Sonar æ‰«æï¼Œæ•°æ®ä¸ŠæŠ¥ç­‰)ï¼Œåœ¨ test é˜¶æ®µä¸­ä½¿ç”¨äº† Cypress çš„å®˜æ–¹é•œåƒ <code>cypress/base:10</code>ã€‚ï¼ˆå…¶å®ƒç¯å¢ƒå˜é‡è®¾ç½®å’Œä¾èµ–å¦‚ Sonar æ‰«æï¼Œyarn ç­‰éƒ½åœ¨æˆ‘ä»¬è‡ªå·±çš„ Docker é•œåƒä¸­ï¼‰</p>
<p>å…¶ä¸­ CI æ‰€æ‰§è¡Œçš„å‘½ä»¤ <code>npm run test</code> æ˜¯ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">"test": "start-server-and-test start http://localhost:5000 cy:run"</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œä¸ºäº†ç®€åŒ–å‘½ä»¤ï¼Œä½¿ç”¨äº† npm åŒ… <a href="https://github.com/bahmutov/start-server-and-test" target="_blank" rel="external">start-server-and-test</a> æ¥å®ç°å¾…æœ¬åœ° Server å¯åŠ¨ä¹‹åå†æ‰§è¡Œæµ‹è¯•è¿™ä¸€é€»è¾‘ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿåœ¨ <code>.gitlab-ci.yml</code> ä¸­è®¾ç½®äº† <code>artifacts</code>:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attr">artifacts:</span></div><div class="line"><span class="attr">  expire_in:</span> <span class="number">1</span> week</div><div class="line"><span class="attr">  when:</span> always</div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">  -</span> coverage/lcov.info</div><div class="line"><span class="bullet">  -</span> cypress/screenshots</div><div class="line"><span class="bullet">  -</span> cypress/videos</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ Gitlab çš„ <a href="https://docs.gitlab.com/ee/user/project/pipelines/job_artifacts.html" target="_blank" rel="external">job artifacts</a> åŠŸèƒ½ï¼Œå¯ä»¥è®¾ç½®åœ¨æŸä¸€æ­¥éª¤å®Œæˆä¹‹åå°†ç‰¹å®šæ–‡ä»¶å¤¹çš„å†…å®¹ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œåœ¨æœ‰æ•ˆæ—¶é—´å†…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç½‘é¡µç«¯æŸ¥çœ‹æˆ–ä¸‹è½½è¿™äº›æ–‡ä»¶å†…å®¹ã€‚è¿™æ ·å¦‚æœåœ¨ CI æµ‹è¯•å¤±è´¥çš„è¯æˆ‘ä»¬å°±å¯ä»¥åœ¨ artifacts ä¸­æŸ¥çœ‹å…¶æµ‹è¯•å¤±è´¥è§†é¢‘å’Œå¿«ç…§ï¼Œé¿å…ç›²çŒœå¼ Debugã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89hawui46j307o03ldfu.jpg" alt="artifacts"></p>
<p>åœ¨ CI è®¾ç½®å’Œæµ‹è¯•ç”¨ä¾‹ç®¡ç†ä¸­å¯ä»¥æ·±æŒ–çš„ç‚¹è¿˜æœ‰å¾ˆå¤šã€‚æ¯”å¦‚å°†æµ‹è¯•ç”¨ä¾‹åˆ†ä¸ºå†’çƒŸæµ‹è¯•ï¼Œå…¨é‡æµ‹è¯•ï¼Œæˆ–è€… Client ç«¯æµ‹è¯•ï¼ŒNode å±‚æµ‹è¯•ç­‰ç­‰ã€‚</p>
<p>Cypress å¯åº”ç”¨çš„æµ‹è¯•åœºæ™¯ä¹Ÿæ›´å¤šï¼Œæ¯”å¦‚é€šè¿‡è®¾ç½® Cookie å®ç°ä¸åŒæƒé™ç”¨æˆ·çš„æµ‹è¯•ï¼Œå¼•å…¥ Chance.js å®ç°éšæœºç‚¹å‡» Tab è¿›è¡Œä¸åŒé€‰é¡¹å¡çš„æµ‹è¯•ï¼ŒMock æ¥å£è¿”å›å€¼ç­‰ç­‰ã€‚</p>
<p><a href="https://glebbahmutov.com/blog/" target="_blank" rel="external">https://glebbahmutov.com/blog/</a> æ˜¯ Cypress çš„ä¸»è¦ç»´æŠ¤è€…çš„åšå®¢ï¼Œå…¶ä¸­ä¹Ÿè®°å½•äº†å¾ˆå¤šéªšæ“ä½œï¼ˆæ¯”å¦‚æ£€æŸ¥ç½‘é¡µå¯¹æ¯”åº¦æ˜¯å¦æ»¡è¶³æ¡ä»¶ç­‰ç­‰ï¼‰ï¼Œå¦‚æœ‰å…´è¶£ï¼Œå¯ä»¥ç»§ç»­è¿›è¡ŒæŒ–æ˜ã€‚</p>
<h2 id="ä¸€ä¸ªå‘ç‚¹"><a href="#ä¸€ä¸ªå‘ç‚¹" class="headerlink" title="ä¸€ä¸ªå‘ç‚¹"></a>ä¸€ä¸ªå‘ç‚¹</h2><p>åœ¨æˆ‘çš„å®è·µä¸­å‘ç°çš„ä¸€ä¸ªå‘ç‚¹æ˜¯ <a href="https://github.com/cypress-io/cypress/issues/95" target="_blank" rel="external">Cypress ç¼ºå°‘å¯¹äº <code>fetch</code> è¯·æ±‚çš„æ”¯æŒ</a>ï¼Œå®ƒæ— æ³•æ•æ‰æˆ–è€… mock è¯·æ±‚ï¼Œåªèƒ½é€šè¿‡ä¸€ä¸ªæœ‰ç‚¹è„çš„æ–¹æ³•æ¥ hack è§£å†³ã€‚</p>
<p>åœ¨é¡¹ç›®ä¸­å¼•å…¥<a href="https://github.com/whatwg/fetch" target="_blank" rel="external">whatwg-fetch</a>ï¼Œå†ä¿®æ”¹ <code>cypress/support/command.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cypress/support/command.js</span></div><div class="line">Cypress.Commands.add(<span class="string">'visitWithDelWinFetch'</span>, (path, opts = &#123;&#125;) =&gt; &#123;</div><div class="line">    cy.visit(</div><div class="line">        path,</div><div class="line">        <span class="built_in">Object</span>.assign(opts, &#123;</div><div class="line">            onBeforeLoad(win) &#123;</div><div class="line">                <span class="keyword">delete</span> win.fetch;</div><div class="line">            &#125;,</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æµ‹è¯•æˆ‘ä»¬é¡¹ç›®çš„ç™»å½•é‡å®šå‘åˆ¤æ–­äº†ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'Node server'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  it(<span class="string">'no cookie get 401'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    cy.server()</div><div class="line"></div><div class="line">    cy.clearCookies()</div><div class="line"></div><div class="line">    cy.route(<span class="string">'POST'</span>, <span class="string">'**/graphql'</span>).as(<span class="string">'login'</span>)</div><div class="line"></div><div class="line">    cy.visitWithDelWinFetch(<span class="string">'/'</span>);</div><div class="line"></div><div class="line">    cy.wait(<span class="string">'@login'</span>).then((xhr) =&gt; &#123;</div><div class="line">      expect(xhr.status).to.eq(<span class="number">401</span>)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'with cookie get 200'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    cy.server()</div><div class="line"></div><div class="line">    cy.route(<span class="string">'POST'</span>, <span class="string">'**/graphql'</span>).as(<span class="string">'loginWithCookie'</span>)</div><div class="line"></div><div class="line">    cy.visitWithCookie(<span class="string">'/'</span>);</div><div class="line"></div><div class="line">    cy.wait(<span class="string">'@loginWithCookie'</span>).then((xhr) =&gt; &#123;</div><div class="line">      expect(xhr.status).to.eq(<span class="number">200</span>)</div><div class="line">    &#125;)</div><div class="line">    <span class="comment">// login successfully, so display the content</span></div><div class="line">    cy.get(<span class="string">'.ant-layout-sider'</span>)</div><div class="line">    cy.get(<span class="string">'.ant-layout-content'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>aha~</p>
<p><img src="https://tva1.sinaimg.cn/large/007X8olVly1g89hawob9rj31180560ta.jpg" alt="sonar"></p>
</div></article></div></main><footer><div class="paginator"><a href="/post/2019/understand-golang-slice/" class="prev">PREV</a><a href="/post/2019/2019-webpack-optimization/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2015 - 2020 <a href="https://blog.colafornia.me">Colafornia</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-84469017-1",'auto');ga('send','pageview');</script></body></html>